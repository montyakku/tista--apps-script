# スプレッドシートからSendGridコンタクト更新ツール

このツールは、スプレッドシートのデータを読み取って、SendGridのコンタクトの `last_event_attended_at` カスタムフィールドを更新します。

## 前提条件

### 1. SendGridLibライブラリの設定

このスクリプトは `SendGridLibrary` を外部ライブラリとして使用します。以下の手順でライブラリを追加してください：

1. Google Apps Scriptエディタで「ライブラリ」→「ライブラリを追加」
2. SendGridLibのスクリプトIDを入力
3. 識別子を `SendGridLibrary` に設定
4. 最新バージョンを選択して保存

### 2. SendGrid API設定

SendGridLibライブラリが適切に設定されている必要があります：

- SendGrid API キーがプロパティに設定済み
- 必要なカスタムフィールド `last_event_attended_at` がSendGridで作成済み

## スプレッドシート形式

**「シート2」**に以下の形式でデータを準備してください：

| A列（メールアドレス） | B列（名前） | C列（last_event_attended_at） |
|-------------------|-------------|------------------------------|
| メールアドレス        | 名前        | 最終参加日                     |
| user@example.com  | 田中太郎      | 2023/12/15                   |
| user2@example.com | 佐藤花子      | 2023/12/20                   |

### 重要事項

- **1行目**: ヘッダー行（タイトル）
- **2行目以降**: 実際のデータ
- **A列**: メールアドレス（必須）
- **B列**: 名前（新規作成時にfirst_nameフィールドに設定）
- **C列**: 最終イベント参加日（必須）
  - 形式: `YYYY/MM/DD` （例: 2023/12/15）
  - 日本時間として処理されます
- **対象シート**: 「シート2」を使用

## 使用方法

### 基本的な使い方

1. 対象のスプレッドシートを開く
2. Google Apps Scriptエディタで `main.gs` を開く
3. `updateContactsFromSpreadsheet()` 関数を実行

### テスト実行

初回使用時は以下の関数でテストすることを推奨：

```javascript
testUpdateContactsFromSpreadsheet()
```

この関数は：
- 日付変換のテストを実行
- 実際の更新処理を実行
- ログでテスト結果を確認可能

## 処理内容

1. **スプレッドシート読み取り**: アクティブシートの全データを取得
2. **日付変換**: DD/MM/YYYY形式を日本時間としてUnixタイムスタンプに変換
3. **コンタクト検索**: SendGridでメールアドレスによる検索
4. **新規作成**: コンタクトが存在しない場合は新規作成
5. **カスタムフィールド更新**: `last_event_attended_at` を更新

## ログ出力例

```
処理対象: 150 件のレコード
新規コンタクト作成: user@example.com (名前: 田中太郎, ID: 12345)
更新成功 (Row 2): user@example.com -> 2023/12/15
更新成功 (Row 3): user2@example.com -> 2023/12/20
=== 処理完了 ===
成功: 148 件
エラー: 2 件
```

## エラーハンドリング

- 空のメールアドレスまたは日付：スキップして次の行を処理
- 無効な日付形式：エラーログ出力してスキップ
- SendGrid API エラー：エラーログ出力して次の行を処理
- 最終的に成功数とエラー数を集計してログ出力

## 注意事項

- SendGrid Legacy API（v3 contactdb）を使用
- 大量データ処理時はSendGrid API制限に注意
- 実行前にテスト環境での動作確認を推奨
- バックアップデータの事前取得を推奨